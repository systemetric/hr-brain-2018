<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Nice Robot</title>

  <link rel="stylesheet" href="prism.css">

  <script src="blockly/blockly_compressed.js"></script>
  <script src="blockly/python_compressed.js"></script>
  <script src="blockly/robot-block-generators.js"></script>
  <script src="blockly/blocks_compressed.js"></script>
  <script src="blockly/robot-block-definitions.js"></script>
  <script src="blockly/msg/js/en-gb.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    nav {
      position: absolute;
      top: 0;
      height: 52px;
      left: 0;
      right: 0;
      background-color: #333333;
    }

    nav > * {
      font-size: 14px;
      line-height: 14px;
      padding: 8px;
      height: 14px;
      vertical-align: center;
      margin: 11px;
      color: white;
      display: inline-block;
      background-color: none;
    }

    nav > .selectable {
      cursor: pointer;
      border-radius: 4px;
      margin-left: 0;
      background-color: #4CAF50;
    }

    nav > .selectable:hover {
      background-color: #388E3C;
    }

    nav > .selectable.running {
      background-color: #FFC107;
      cursor: not-allowed;
    }

    #build-button {
      align-self: center;
      justify-self: center;
    }

    #blockly-area {
      position: absolute;
      top: 52px;
      left: 0;
      right: 300px;
      bottom: 0;
    }

    #blockly-div {
      position: absolute;
    }

    #output-area {
      position: absolute;
      top: 52px;
      right: 0;
      width: 268px;
      bottom: 0;
      margin: 0;
    }
  </style>
</head>
<body>
  <nav>
    <p>Nice Robot</p>
    <p class="selectable" id="build-button">Run on Robot</p>
  </nav>

  <div id="blockly-area"></div>

  <div id="blockly-div"></div>

  <xml id="toolbox" style="display: none">
    <category name="Text">
        <block type="text"></block>
        <block type="text_print"></block>
    </category>
    <category name="Logic">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
        <block type="logic_null"></block>
        <block type="logic_ternary"></block>
    </category>
    <category name="Loops">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <field name="VAR">i</field>
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
        <value name="BY">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="math_constrain">
        <value name="LOW">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="HIGH">
          <block type="math_number">
            <field name="NUM">100</field>
          </block>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">100</field>
          </block>
        </value>
      </block>
      <block type="math_random_float"></block>
    </category>
    <category name="Lists">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <block type="math_number">
            <field name="NUM">5</field>
          </block>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
    </category>
    <category name="Variables" custom="VARIABLE"></category>
    <category name="Functions" custom="PROCEDURE"></category>
    <sep></sep>
    <category name="Robot">
      <block type="robot_move"></block>
      <block type="robot_turn"></block>
      <block type="robot_pickup"></block>
      <block type="robot_drop"></block>
      <block type="robot_find_go_cube"></block>
      <block type="robot_find_go_bucket"></block>
    </category>
  </xml>

  <pre id="output-area"><code id="code-area" class="language-python"></code></pre>

  <script src="prism.js" data-manual></script>
  <script>
    var blocklyArea = document.getElementById('blockly-area');
    var blocklyDiv = document.getElementById('blockly-div');
    var buildButton = document.getElementById('build-button');
    var codeArea = document.getElementById('code-area');

    var workspace = Blockly.inject(blocklyDiv,
        {toolbox: document.getElementById('toolbox')});
    var onresize = function(e) {
      // Compute the absolute coordinates and dimensions of blocklyArea.
      var element = blocklyArea;
      var x = 0;
      var y = 0;
      do {
        x += element.offsetLeft;
        y += element.offsetTop;
        element = element.offsetParent;
      } while (element);
      // Position blocklyDiv over blocklyArea.
      blocklyDiv.style.left = x + 'px';
      blocklyDiv.style.top = y + 'px';
      blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
      blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
    };
    window.addEventListener('resize', onresize, false);
    onresize();
    Blockly.svgResize(workspace);

    var generateCode = function(header='from nicerobot import *\nimport time\n\n') {
      return header + Blockly.Python.workspaceToCode(workspace);
    }

    let running = false;
    buildButton.addEventListener('click', function(e) {
      if(running) return;

      running = true;
      buildButton.innerHTML = "Running...";
      buildButton.classList.add("running");

      fetch('/run', {
        body: JSON.stringify({
          code: generateCode()
        }),
        headers: { 'content-type': 'application/json' },
        method: "POST"
      }).then(res => {
        running = false;
        buildButton.innerHTML = "Run on Robot";
        buildButton.classList.remove("running");
      });
    });

    workspace.addChangeListener(function(e) {
      codeArea.innerHTML = generateCode('');
      Prism.highlightElement(codeArea, true);
    });
    codeArea.innerHTML = generateCode('');
    Prism.highlightElement(codeArea, true);
  </script>
</body>
</html>